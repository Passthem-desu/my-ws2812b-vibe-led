# 💡 渲染管线 Lua 脚本编写指南

本系统使用 Lua 脚本作为核心渲染逻辑。每个渲染层（RenderLayer）都包含一段独立的 Lua 代码，在每一帧渲染时按优先级顺序执行。

## 🎨 颜色约定：使用 $0.0 - 1.0$ 浮点数

与传统的 8 位颜色（$0-255$）不同，本管线中的 Lua 脚本必须使用**浮点数**表示颜色，范围从 $0.0$（最小亮度/关闭）到 $1.0$（最大亮度/全开）。

**示例:**

| **颜色** | **红色 (R)** | **绿色 (G)** | **蓝色 (B)** | 
| :--- | :--- | :--- | :--- |
| 纯白 | `1.0` | `1.0` | `1.0` | 
| 纯红 | `1.0` | `0.0` | `0.0` | 
| 中等亮度灰 | `0.5` | `0.5` | `0.5` | 
| 关闭（黑） | `0.0` | `0.0` | `0.0` | 

> ⚙️ **注意:** 你的浮点颜色值在被写入像素缓冲区之前，会被系统进行内部的伽马校正（gamma correction）和硬件颜色偏置（hardware color bias）处理。

## 🛠️ 全局可用的 Lua 函数

在你的 Lua 脚本中，你可以访问以下三个全局函数：

### 1. `get_time()`

获取自管线启动以来经过的时间（以秒为单位）。

* **用途:** 用于创建随时间变化的动画效果。

* **返回值:** 一个浮点数 (`number`)，表示秒数。

```lua
-- 让动画每 5 秒重复一次
local time = get_time()
local phase = (time % 5.0) / 5.0  -- phase now cycles from 0.0 to 1.0 every 5s
````

### 2\. `set_pixel(index, r, g, b)`

设置指定 LED 像素的颜色。

  * **用途:** 这是绘制灯光效果的主要方法。

  * **参数:**

    1.  `index` (`number`): LED 的索引，从 $0$ 开始，直到 `LEDCount - 1`。

    2.  `r` (`number`): 红色分量，范围 $0.0 - 1.0$。

    3.  `g` (`number`): 绿色分量，范围 $0.0 - 1.0$。

    4.  `b` (`number`): 蓝色分量，范围 $0.0 - 1.0$。

<!-- end list -->

```lua
-- 将第 10 个 LED 设置为中等亮度的蓝色
set_pixel(10, 0.0, 0.0, 0.5)
```

### 3\. `get_pixel(index)`

获取指定 LED 像素的当前颜色。

  * **用途:** 允许图层读取前一个图层已经渲染的颜色，用于实现复杂的滤镜或依赖于背景的动态效果。

  * **参数:**

    1.  `index` (`number`): LED 的索引。

  * **返回值:** 三个浮点数 (`number, number, number`)，分别代表当前像素的 $R, G, B$ 值（范围 $0.0 - 1.0$）。

<!-- end list -->

```lua
-- 获取第 5 个像素的当前颜色
local r, g, b = get_pixel(5)

-- 将获取到的颜色亮度加倍（钳制在 1.0）
r = math.min(1.0, r * 2.0)
g = math.min(1.0, g * 2.0)
b = math.min(1.0, b * 2.0)

-- 将新颜色设置回第 5 个像素
set_pixel(5, r, g, b)
```

## 🚥 图层类型与行为

系统支持不同类型的渲染层，它们决定了图层的作用和生命周期。

### 1\. `BASE` (基础层)

  * **作用:** 设定灯光的默认背景，通常是一个恒定的颜色或最基础的动画。

  * **行为:** 总是使用 **`ModeBase`**（覆盖）模式。当添加一个新的 `BASE` 层时，**任何现有的 `BASE` 层都会被自动删除**，确保始终只有一个基础层。

  * **示例:** 一个简单的纯色背景。

<!-- end list -->

```lua
-- BASE 层: 设置所有灯为柔和的蓝色背景
for i=0, LEDCount-1 do
    set_pixel(i, 0.0, 0.0, 0.1)
end
```

### 2\. `TEMPORARY` (临时层)

  * **作用:** 用于短期的、一次性的视觉效果，如闪烁、通知或过渡动画。

  * **行为:** 使用 **`ModeOverwrite`**（覆盖）模式。它会根据你在添加时设置的 `timeout` 值，在渲染循环中自动检查并删除。

  * **生命周期:** 由 `TimeoutSeconds` 字段控制。一旦超过设定的时间，它将在下一帧被移除。

  * **示例:** 一个持续 1 秒的白光闪烁效果。

<!-- end list -->

```lua
-- TEMPORARY 层: 创建一个随时间衰减的白色闪烁效果
-- 假设 TimeoutSeconds = 1.0
local time = get_time()
local elapsed = time - (AddedAt in seconds) -- 实际在 Go 中计算
local fade_out = 1.0 - (elapsed / 1.0)      -- 1.0s 内从 1.0 衰减到 0.0

-- 只影响中间的几个 LED
for i=30, 33 do
    local brightness = math.max(0.0, fade_out)
    set_pixel(i, brightness, brightness, brightness)
end
```
